<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© ØªÙ†ÙÙŠØ° Ù…Ø´Ø±ÙˆØ¹ "Ø£ÙˆØ¨Ø± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©" â€“ Roadmap</title>
<style>
  :root{
    --bg:#0e0f13;
    --card:#151821;
    --muted:#aab0c0;
    --text:#e8ecf4;
    --brand:#2a72ff;   /* Ø£Ø²Ø±Ù‚ Ø·Ø¨Ø§Ø¹Ø© */
    --accent:#ff7a2a;  /* Ù„Ù…Ø³Ø© Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
    --ok:#22c55e;
    --warn:#f59e0b;
    --danger:#ef4444;
    --radius:18px;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:radial-gradient(1200px 600px at 80% -10%,rgba(42,114,255,.12),transparent 60%),
    radial-gradient(1000px 500px at -10% 120%,rgba(255,122,42,.12),transparent 60%),var(--bg);
    color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",Tahoma;
  }
  header{
    position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(14,15,19,.95),rgba(14,15,19,.75));backdrop-filter: blur(6px);
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .container{max-width:1100px;margin:auto;padding:18px}
  .topbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between}
  .title{display:flex;gap:12px;align-items:center}
  .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--brand),#0ea5e9);display:grid;place-items:center;box-shadow:var(--shadow)}
  .logo i{font-style:normal;font-weight:800;color:white}
  h1{font-size:20px;margin:0}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid rgba(255,255,255,.12);background:#0f121a;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;transition:.2s;display:inline-flex;gap:8px;align-items:center}
  .btn:hover{background:#131827;border-color:rgba(255,255,255,.22)}
  .btn.primary{background:linear-gradient(135deg,var(--brand),#5aa0ff);border-color:transparent;color:white}
  .btn.accent{background:linear-gradient(135deg,var(--accent),#ffaa79);border-color:transparent;color:#1f1309}
  .btn.ghost{background:transparent}
  .btn.small{padding:8px 10px;border-radius:10px;font-size:14px}
  .search{min-width:240px}
  input[type="search"], input[type="date"], input[type="text"]{
    background:#0f121a;color:var(--text);border:1px solid rgba(255,255,255,.12);padding:10px 12px;border-radius:12px;outline:none;transition:.2s
  }
  input[type="search"]:focus, input[type="date"]:focus, input[type="text"]:focus{border-color:var(--brand)}
  .meta{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin-top:10px}
  .kpi{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);padding:12px 14px;border-radius:14px;display:flex;gap:8px;align-items:center}
  .kpi .dot{width:10px;height:10px;border-radius:50%}
  .kpi .val{font-weight:700}
  .progress-wrap{margin:14px 0}
  .progress{height:12px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
  .progress > span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--brand),#5aa0ff);transition:width .4s ease}

  main{padding:24px 18px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:880px){.grid{grid-template-columns:1fr 1fr}}

  .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card .hd{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid rgba(255,255,255,.08)}
  .card .hd h3{margin:0;font-size:18px}
  .phase-kpis{display:flex;gap:10px;align-items:center}
  .badge{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);font-size:12px;color:var(--muted)}
  .badge.ok{border-color:rgba(34,197,94,.35);color:#a7f3d0}
  .badge.warn{border-color:rgba(245,158,11,.4);color:#fde68a}
  .list{padding:14px}
  .task{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;padding:10px;border-radius:12px}
  .task:hover{background:rgba(255,255,255,.03)}
  .task label{cursor:pointer}
  .task .name{font-weight:600}
  .task .hint{font-size:12px;color:var(--muted)}
  .task .when{display:flex;gap:8px;align-items:center}
  .task input[type="checkbox"]{width:18px;height:18px;accent-color:var(--brand);cursor:pointer}
  .phase-progress{margin:10px 16px 16px}
  .phase-progress .progress{height:8px}

  footer{padding:24px;color:var(--muted);text-align:center}

  .toast{position:fixed;bottom:24px;left:24px;right:auto;z-index:100;background:#10151f;border:1px solid rgba(255,255,255,.12);padding:12px 14px;border-radius:12px;opacity:0;transform:translateY(16px);transition:.3s;pointer-events:none}
  .toast.show{opacity:1;transform:translateY(0)}

  .lang-toggle{margin-inline-start:6px}
  .pill{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;font-size:12px}

  /* Tooltip */
  .tip{position:relative}
  .tip:hover::after{content:attr(data-tip);position:absolute;bottom:120%;right:0;background:#0f121a;border:1px solid rgba(255,255,255,.12);padding:8px 10px;border-radius:8px;white-space:nowrap;color:var(--muted);font-size:12px}

  /* EN mode (LTR) support */
  body.ltr{direction:ltr}
</style>
</head>
<body>
  <header>
    <div class="container">
      <div class="topbar">
        <div class="title">
          <div class="logo"><i>UP</i></div>
          <h1 id="appTitle">Ù„ÙˆØ­Ø© ØªÙ†ÙÙŠØ° Ù…Ø´Ø±ÙˆØ¹ "Ø£ÙˆØ¨Ø± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©"</h1>
        </div>
        <div class="controls">
          <input id="search" class="search" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù‡Ù…Ø©â€¦ (Ø§Ø³Ù… Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©)" />
          <button class="btn small" id="toggleLang" title="Language / Ø§Ù„Ù„ØºØ©">AR/EN</button>
          <button class="btn small" id="printBtn">Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn small" id="exportBtn">ØªØµØ¯ÙŠØ± ØªÙ‚Ø¯Ù…</button>
          <label class="btn small" for="importFile">Ø§Ø³ØªÙŠØ±Ø§Ø¯</label>
          <input id="importFile" type="file" accept="application/json" hidden />
          <button class="btn small ghost" id="resetBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
          <a class="btn small primary" id="saveAppBtn" download="UberPrint-Roadmap.html">ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø©</a>
        </div>
        <div class="meta">
          <div class="kpi"><span class="dot" style="background:var(--brand)"></span><span class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…:</span>&nbsp;<span class="val" id="kpiTotal">0</span></div>
          <div class="kpi"><span class="dot" style="background:var(--ok)"></span><span class="label">Ø§Ù„Ù…Ù†Ø¬Ø²:</span>&nbsp;<span class="val" id="kpiDone">0</span></div>
          <div class="kpi"><span class="dot" style="background:var(--accent)"></span><span class="label">Ø§Ù„Ù†Ø³Ø¨Ø©:</span>&nbsp;<span class="val" id="kpiPct">0%</span></div>
          <div class="kpi tip" data-tip="Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© ØªÙ…Ø§Ù…Ù‹Ø§">
            <span class="dot" style="background:linear-gradient(135deg,var(--accent),#ffaa79)"></span>
            <span class="label">Ù…Ø±Ø§Ø­Ù„ Ù…ÙƒØªÙ…Ù„Ø©:</span>&nbsp;<span class="val" id="kpiPhases">0</span>
          </div>
        </div>
        <div class="progress-wrap">
          <div class="progress" aria-label="overall progress"><span id="overallBar"></span></div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid" id="phasesGrid"><!-- Phases render here --></div>
  </main>

  <footer>
    <span class="pill">ÙŠØ­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ (Local Storage)</span>
  </footer>

  <div class="toast" id="toast"></div>

<script>
// ========= Data =========
const PHASES = [
  {
    key: 'foundation',
    ar: {title: 'Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø§Ù„ØªØ£Ø³ÙŠØ³ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±ÙŠ', hint: 'Ù…Ø¯Ø© ØªÙ‚Ø¯ÙŠØ±ÙŠØ©: 2â€“3 Ø£Ø³Ø§Ø¨ÙŠØ¹', start: 0, days: 18},
    en: {title: 'Phase 1: Foundation (Legal & Admin)', hint: 'Estimated: 2â€“3 weeks'},
    tasks: [
      { key:'biz-plan',     ar:'Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„ (Business Plan)', en:'Business Plan'},
      { key:'bmc',          ar:'Business Model Canvas',     en:'Business Model Canvas'},
      { key:'founders',     ar:'Ø§ØªÙØ§Ù‚ Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠÙ† ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­ØµØµ', en:'Foundersâ€™ Agreement & Equity Split'},
      { key:'bylaws',       ar:'Ø§Ù„Ù„Ø§Ø¦Ø­Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© / Operating Agreement', en:'Bylaws / Operating Agreement'},
      { key:'org-roles',    ar:'Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠ ÙˆØªÙˆØµÙŠÙ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±', en:'Org Structure & Role Descriptions'}
    ]
  },
  {
    key: 'technical',
    ar: {title: 'Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„ØªÙ‚Ù†ÙŠ', hint: 'Ù…Ø¯Ø©: 3â€“4 Ø£Ø³Ø§Ø¨ÙŠØ¹', start: 18, days: 24},
    en: {title: 'Phase 2: Technical Planning', hint: 'Estimated: 3â€“4 weeks'},
    tasks: [
      { key:'srs',         ar:'SRS â€“ Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©', en:'SRS â€“ Software Requirements Spec'},
      { key:'arch',        ar:'Ø±Ø³Ù… Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ© (Architecture Diagram)', en:'System Architecture Diagram'},
      { key:'dfd',         ar:'ØªØ¯ÙÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (DFD)', en:'Data Flow Diagram (DFD)'},
      { key:'apis',        ar:'ØªÙˆØ«ÙŠÙ‚ ØªÙƒØ§Ù…Ù„Ø§Øª API (Ø§Ù„Ø´Ø­Ù†/Ø§Ù„Ø¯ÙØ¹/Ø§Ù„Ù…Ø·Ø§Ø¨Ø¹)', en:'API Integration Docs'},
      { key:'ux',          ar:'Ø¥Ø±Ø´Ø§Ø¯Ø§Øª UX/UI + Ù†Ù…Ø§Ø°Ø¬ Ø£ÙˆÙ„ÙŠØ©', en:'UI/UX Guidelines + Wireframes'}
    ]
  },
  {
    key: 'operations',
    ar: {title: 'Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª', hint: 'Ù…Ø¯Ø©: 4 Ø£Ø³Ø§Ø¨ÙŠØ¹', start: 42, days: 28},
    en: {title: 'Phase 3: Operations & SOPs', hint: 'Estimated: 4 weeks'},
    tasks: [
      { key:'ops-manual',  ar:'Ø¯Ù„ÙŠÙ„ Ø§Ù„ØªØ´ØºÙŠÙ„ (Operations Manual)', en:'Operations Manual'},
      { key:'sops',        ar:'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© (SOPs)', en:'Standard Operating Procedures (SOPs)'},
      { key:'qa',          ar:'Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ø´ÙƒØ§ÙˆÙ‰', en:'Quality Assurance Manual'},
      { key:'slas',        ar:'Ø§ØªÙØ§Ù‚ÙŠØ§Øª Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø¯Ù…Ø© (SLAs)', en:'Service Level Agreements (SLAs)'},
      { key:'support',     ar:'Ø¯Ù„ÙŠÙ„ Ø¯Ø¹Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Playbook)', en:'Customer Support Playbook'}
    ]
  },
  {
    key: 'legal',
    ar: {title: 'Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆØ§Ù„Ø§Ù…ØªØ«Ø§Ù„', hint: 'Ù…Ø¯Ø©: 2â€“3 Ø£Ø³Ø§Ø¨ÙŠØ¹', start: 70, days: 18},
    en: {title: 'Phase 4: Legal & Compliance', hint: 'Estimated: 2â€“3 weeks'},
    tasks: [
      { key:'terms',       ar:'Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (Terms & Conditions)', en:'Terms & Conditions'},
      { key:'privacy',     ar:'Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©', en:'Privacy Policy'},
      { key:'merchant',    ar:'Ø¹Ù‚Ø¯ Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ù…Ø·Ø¨Ø¹Ø©', en:'Merchant / Printer Agreement'},
      { key:'shipping',    ar:'Ø¹Ù‚Ø¯ Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù†', en:'Shipping Partner Agreement'},
      { key:'tax',         ar:'Ù…Ù„Ù Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ (ÙØ§ØªÙˆØ±Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©/ØªÙƒÙˆÙŠØ¯)', en:'Tax Compliance File'},
      { key:'pricing',     ar:'Ø³ÙŠØ§Ø³Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ± ÙˆØ§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª', en:'Pricing & Commission Policy'},
      { key:'finance',     ar:'Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ®Ø·Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©', en:'Financial Model & Budget Plan'}
    ]
  },
  {
    key: 'marketing',
    ar: {title: 'Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆØ§Ù„ØªØ³ÙˆÙŠÙ‚', hint: 'Ù…Ø¯Ø©: 3 Ø£Ø³Ø§Ø¨ÙŠØ¹', start: 88, days: 21},
    en: {title: 'Phase 5: Branding & Marketing', hint: 'Estimated: 3 weeks'},
    tasks: [
      { key:'brandbook',   ar:'ÙƒØªØ§Ø¨ Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¨ØµØ±ÙŠØ© (Brand Book)', en:'Brand Book / Visual Identity'},
      { key:'mkt-strat',   ar:'Ø®Ø·Ø© Ø§Ù„ØªØ³ÙˆÙŠÙ‚ (Digital / SEO / Ads)', en:'Marketing Strategy Document'},
      { key:'content',     ar:'Ø®Ø·Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„Ø©', en:'Content Plan & Calendar'},
      { key:'affiliate',   ar:'Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª ÙˆØ§Ù„Ø´Ø±Ø§ÙƒØ§Øª', en:'Affiliate / Referral Program Policy'}
    ]
  },
  {
    key: 'security',
    ar: {title: 'Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6: Ø§Ù„Ø£Ù…Ù† ÙˆØ§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø©', hint: 'Ù…Ø³ØªÙ…Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚', start: 109, days: 30},
    en: {title: 'Phase 6: Security & Sustainability', hint: 'Ongoing after launch'},
    tasks: [
      { key:'infosec',     ar:'Ø³ÙŠØ§Ø³Ø© Ø£Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª', en:'Information Security Policy'},
      { key:'backup',      ar:'Ø®Ø·Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø·ÙˆØ§Ø±Ø¦', en:'Backup & Disaster Recovery Plan'},
      { key:'risk',        ar:'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆØ®Ø·Ø· Ø§Ù„ØªØ®ÙÙŠÙ', en:'Risk Assessment & Mitigation'}
    ]
  }
];

const APP_KEY = 'uberprint_roadmap_state_v1';
let state = loadState();
let currentLang = state.lang || 'ar';

function todayISO(){
  const d = new Date();
  d.setHours(0,0,0,0);
  return d.toISOString().slice(0,10);
}

function loadState(){
  try{ return JSON.parse(localStorage.getItem(APP_KEY)) || { tasks:{}, phases:{}, lang:'ar' }; }
  catch{ return { tasks:{}, phases:{}, lang:'ar' }; }
}

function saveState(){
  localStorage.setItem(APP_KEY, JSON.stringify(state));
}

function idFor(phaseKey, taskKey){ return `${phaseKey}__${taskKey}`; }

function render(){
  document.body.classList.toggle('ltr', currentLang==='en');
  document.getElementById('appTitle').textContent = currentLang==='ar' ? 'Ù„ÙˆØ­Ø© ØªÙ†ÙÙŠØ° Ù…Ø´Ø±ÙˆØ¹ "Ø£ÙˆØ¨Ø± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©"' : 'Project Roadmap â€“ Uber Print';

  const grid = document.getElementById('phasesGrid');
  grid.innerHTML = '';

  let total=0, done=0, phasesDone=0;

  const startBase = new Date(); // Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¯Ø§ÙŠØ© Ù…Ø±Ø¬Ø¹ÙŠØ©
  startBase.setHours(0,0,0,0);

  PHASES.forEach(phase => {
    const tList = phase.tasks;
    const pState = state.phases[phase.key] || {};
    const pDoneCount = tList.filter(t => !!state.tasks[idFor(phase.key,t.key)]).length;
    const pTotal = tList.length;
    const pct = Math.round((pDoneCount / pTotal) * 100);
    const complete = pDoneCount===pTotal && pTotal>0;

    total += pTotal; done += pDoneCount; if(complete) phasesDone++;

    // dates
    const startOffset = phase.ar.start || 0; // days offset
    const startDate = new Date(startBase.getTime() + startOffset*24*3600*1000);
    const dueDateDefault = new Date(startDate.getTime() + (phase.ar.days||14)*24*3600*1000);

    const selTitle = currentLang==='ar' ? phase.ar.title : phase.en.title;
    const selHint  = currentLang==='ar' ? phase.ar.hint  : phase.en.hint;

    const card = document.createElement('section');
    card.className='card';
    card.innerHTML = `
      <div class="hd">
        <h3>${selTitle}</h3>
        <div class="phase-kpis">
          <span class="badge">${selHint}</span>
          <span class="badge">${currentLang==='ar'?'Ø§Ù„Ù…Ù‡Ø§Ù…':''} ${pDoneCount}/${pTotal}</span>
          <span class="badge ${complete?'ok':(pct<50?'warn':'')}">${pct}%</span>
          <span class="badge">${currentLang==='ar'?'Ø¨Ø¯Ø§ÙŠØ©':''} <input type="date" class="small-date" data-phase="${phase.key}" data-kind="start" value="${pState.start||iso(startDate)}"></span>
          <span class="badge">${currentLang==='ar'?'Ù…ÙˆØ¹Ø¯ Ù†Ù‡Ø§Ø¦ÙŠ':''} <input type="date" class="small-date" data-phase="${phase.key}" data-kind="due" value="${pState.due||iso(dueDateDefault)}"></span>
        </div>
      </div>
      <div class="list" id="list_${phase.key}"></div>
      <div class="phase-progress"><div class="progress"><span style="width:${pct}%"></span></div></div>
    `;

    grid.appendChild(card);

    // Render tasks
    const list = card.querySelector('.list');
    tList.forEach(task => {
      const tid = idFor(phase.key, task.key);
      const checked = !!state.tasks[tid];
      const row = document.createElement('div');
      row.className='task';
      row.dataset.search = (task.ar + ' ' + task.en).toLowerCase();
      row.innerHTML = `
        <input id="cb_${tid}" type="checkbox" ${checked?'checked':''}>
        <label for="cb_${tid}">
          <div class="name">${currentLang==='ar'?task.ar:task.en}</div>
          <div class="hint">${currentLang==='ar'?'ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù‡Ù…Ø©':''} Â· <span id="st_${tid}">${checked? (currentLang==='ar'?'Ù…ÙƒØªÙ…Ù„Ø©':'Done') : (currentLang==='ar'?'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°':'In progress')}</span></div>
        </label>
        <div class="when">
          <input type="date" id="due_${tid}" value="${(state.tasks[tid]&&state.tasks[tid].due)||''}" placeholder="Ù…ÙˆØ¹Ø¯"/>
        </div>
      `;
      list.appendChild(row);

      row.querySelector(`#cb_${tid}`).addEventListener('change', (e)=>{
        setTask(tid, e.target.checked);
        row.querySelector(`#st_${tid}`).textContent = e.target.checked ? (currentLang==='ar'?'Ù…ÙƒØªÙ…Ù„Ø©':'Done') : (currentLang==='ar'?'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°':'In progress');
        render();
        if (isPhaseNowComplete(phase)) toast(`ğŸ‰ ${selTitle} â€” ${currentLang==='ar'?'Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø©':'Phase completed'}`);
        if (getOverallPct()===100) toast('ğŸš€ Ø£Ø­Ø³Ù†Øª! ØªÙ… Ø¥Ù†Ø¬Ø§Ø² Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù….');
      });

      row.querySelector(`#due_${tid}`).addEventListener('change', (e)=>{
        setTaskDue(tid, e.target.value);
      });
    });

    // phase dates handlers
    card.querySelectorAll('.small-date').forEach(inp=>{
      inp.addEventListener('change', (e)=>{
        const k = e.target.dataset.phase; const kind = e.target.dataset.kind;
        state.phases[k] = state.phases[k] || {}; state.phases[k][kind] = e.target.value; saveState();
      })
    });
  });

  // KPIs & overall bar
  const pctAll = total? Math.round((done/total)*100) : 0;
  sel('#kpiTotal').textContent = total;
  sel('#kpiDone').textContent  = done;
  sel('#kpiPct').textContent   = pctAll + '%';
  sel('#kpiPhases').textContent= phasesDone;
  sel('#overallBar').style.width = pctAll + '%';
}

function setTask(id, checked){
  if(!state.tasks[id]) state.tasks[id] = {done:false, due:''};
  state.tasks[id].done = checked; saveState();
}
function setTaskDue(id, dateStr){
  if(!state.tasks[id]) state.tasks[id] = {done:false, due:''};
  state.tasks[id].due = dateStr; saveState();
}
function isPhaseNowComplete(phase){
  return phase.tasks.every(t=> state.tasks[idFor(phase.key,t.key)] && state.tasks[idFor(phase.key,t.key)].done );
}
function getOverallPct(){
  let total=0, done=0; PHASES.forEach(p=>{ total+=p.tasks.length; p.tasks.forEach(t=>{ if(state.tasks[idFor(p.key,t.key)]?.done) done++; }); });
  return total? Math.round(done/total*100) : 0;
}
function iso(d){ return d.toISOString().slice(0,10); }
function sel(q){ return document.querySelector(q); }

// ===== Search =====
const searchEl = document.getElementById('search');
searchEl.addEventListener('input', ()=>{
  const q = searchEl.value.trim().toLowerCase();
  document.querySelectorAll('.task').forEach(row=>{
    const hit = row.dataset.search.includes(q);
    row.style.display = hit? 'grid' : 'none';
  });
});

// ===== Toast =====
const toastEl = document.getElementById('toast');
function toast(msg){
  toastEl.textContent = msg; toastEl.classList.add('show');
  setTimeout(()=> toastEl.classList.remove('show'), 2600);
}

// ===== Export / Import / Reset / Print =====
sel('#exportBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'uberprint-roadmap-progress.json'; a.click();
});
sel('#importFile').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return; const r = new FileReader();
  r.onload = ()=>{ try{ state = JSON.parse(r.result); saveState(); render(); toast('âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­'); } catch{ toast('âš ï¸ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); } };
  r.readAsText(f);
});
sel('#resetBtn').addEventListener('click', ()=>{
  if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ØªÙ‚Ø¯Ù…ØŸ')){ state={tasks:{}, phases:{}, lang:currentLang}; saveState(); render(); }
});
sel('#printBtn').addEventListener('click', ()=> window.print());

// ===== Language toggle (AR/EN) =====
sel('#toggleLang').addEventListener('click', ()=>{ currentLang = currentLang==='ar'?'en':'ar'; state.lang=currentLang; saveState(); render(); });

// ===== Save this app button (self-contained download) =====
(function prepDownload(){
  const btn = sel('#saveAppBtn');
  fetch(location.href).then(r=>r.text()).then(html=>{
    const blob = new Blob([html], {type:'text/html'});
    btn.href = URL.createObjectURL(blob);
  }).catch(()=>{ btn.remove(); });
})();

// ===== First render =====
render();
</script>
</body>
</html>
